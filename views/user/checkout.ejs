<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.css"
        integrity="sha256-NAxhqDvtY0l4xn+YVa6WjAcmd94NNfttjNsDmNatFVc=" crossorigin="anonymous" />
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <link rel="icon" href="https://png.pngtree.com/png-vector/20211013/ourmid/pngtree-letter-t-logo-png-image_3977406.png" type="image/x-icon">

</head>

<body>
    <%- include('navbaruser')%>
        <br>
        <form  class="pay-form" >
         <div class="container">

          <div class="row">
            <div class="col-xl-8 w-100">

            <div class="card">
                <div class="card-body">
                    <ol class="activity-checkout mb-0 px-4 mt-3">


                    <li class="checkout-item">


                        <div class="feed-item-list">
                        <div>
                        <h5 class="font-size-16 mb-1">Shipping Info</h5>
                         <% address.forEach((add)=>{%>
                             <% let i=0%>
                                <div class="mb-3">
                                    <div class="row">
                                    <div class="col-lg-4 col-sm-6">
                                    <div data-bs-toggle="collapse">
                                     <label class="card-radio-label mb-0">
                                      <input type="radio" name="address"
                                        id="info-address1"
                                         class="card-radio-input" value="<%=i%>"checked="">
                                            <div class="card-radio text-truncate p-3">
                                                <span class="fs-14 mb-4 d-block">Address
                                                  <%= i+1 %></span>
                                                     <span class="fs-14 mb-2 d-block">
                                                            <%= add.name%>
                                                        </span>
                                                        <span
                                                        class="text-muted fw-normal text-wrap mb-1 d-block">
                                                        <%= add.housenumber%>
                                                        </span>
                                                         <span
                                                             class="text-muted fw-normal text-wrap mb-1 d-block">
                                                                 <<%= add.area%>
                                                        </span>
                                                       <span
                                                         class="text-muted fw-normal text-wrap mb-1 d-block">
                                                            <%=add.city%>
                                                        </span>

                                                        <span
                                                         class="text-muted fw-normal d-block">Mobile: <%=add.mobile%></span>
                                                            </div>
                                                         </label>
                                                        <input type="text" name="add" value="<%=add%>" hidden>

                                                     </div>
                                                    </div>
                                                     <% i++ %>
                                                     <%})%>
                                                  <a href="/address">Add new address</a>
                                                            </div>
                                                        </div>
                                            </div>
                                        </div>


                                        <div class="feed-item-list">
                                            <div>
                                                <h5 class="font-size-16 mb-1">Payment Info</h5>
                                            </div>
                                            <div>
                                                <h5 class="font-size-14 mb-3">Payment method :</h5>
                                                <div class="row">

                                                    <select class="form-select" id="paymentmethod" name="paymentmethod"
                                                        aria-label="Default select example">
                                                        <option selected>payment options</option>
                                                        <option value="cod">COD</option>
                                                        <option value="online">ONLINE</option>
                                                    </select>


                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ol>
                            </div>
                        </div>

                        <div class="row my-4 ">



                            <!-- end col -->
                        </div> <!-- end row-->
                    </div>
                    <div class="col-xl-4 w-100">
                        <div class="card checkout-order-summary">
                            <div class="card-body">

                                <div class="table-responsive">
                                    <table class="table table-centered mb-0 table-nowrap">
                                        <thead>
                                            <tr>
                                                <th class="border-top-0" scope="col">Product</th>
                                                <th class="border-top-0" scope="col">Price</th>
                                                <th class="border-top-0" scope="col">Quantity</th>
                                                <th class="border-top-0" scope="col">Total</th>



                                            </tr>
                                        </thead>
                                        <% let total=0; %>
                                            <% cart.forEach((ele)=>{%>



                                                <tbody>



                                                    <% const qty=ele.productquantity
                                                       const price=ele.productprice 
                                                       const prodtotal=qty*price 
                                                       total=total+prodtotal 
                                                       %>
                                                        <td>
                                                            
                                                            <h5 class="font-size-16 text-truncate"><a href="#"
                                                                    class="text-dark">
                                                                    <%=ele.productname%>
                                                                </a></h5>

                                                        </td>
                                                        <td>
                                                            <%= ele.productprice%>
                                                        </td>
                                                        <td>
                                                            <%= ele.productquantity%>
                                                        </td>
                                                        <td>Rs.<%= prodtotal%>
                                                        </td>

                                                        </tr>



                                                </tbody>
                                                <input type="text" name="id" value="<%=ele.productid%>" hidden>
                                                <%})%>
                                    </table>

                                </div>

                            </div>
                            <input type="number" name="total" value="<%=total%>" hidden>
                            <div class="col-md-4 ms-3">
                                <div class="card mb-4">
                                    <div class="card-header py-3">
                                        <h5 class="mb-0">Summary</h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-group list-group-flush">
                                            <li
                                                class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                                Products
                                                <span>Rs.<%= total%></span>
                                            </li>
                                            <li
                                                class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                Shipping
                                                <span>Gratis</span>
                                            </li>
                                            <li
                                                class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                                                <div>
                                                    <strong>Total amount</strong>
                                                    <strong>
                                                        <p class="mb-0">(including VAT)</p>
                                                    </strong>
                                                </div>
                                                <span><strong>Rs.<%= total%></strong></span>
                                            </li>
                                        </ul>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end row -->

            </div>

            <br>
            <div class="d-flex justify-content-center mx-4 mb-3 mb-lg-4">
                <button type="submit" class="btn btn-primary btn-lg">Proceed</button>
            </div>
        </form>
        <br>
        <%-include('footer')%>
       
</body>

</html>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>

$(document).ready(function(){
	$('.pay-form').submit(function(e){
		e.preventDefault();

		var formData = $(this).serialize();
        console.log(formData);  
		$.ajax({
			url:"/createorder",
			type:"POST",
			data: formData,
			success:function(res){
				if(res.success){
                    if(res.paymentmethod==='cod'){
                        window.location.href = '/ordersuccess'; // Redirect to "/ordersuccess"

                    }else if(res.paymentmethod==='online'){
                        var options = {
						"key": ""+res.key_id+"",
						"amount": ""+res.amount+"",
						"currency": "INR",
						"name": ""+"TECHNO"+"",
						"image": "https://dummyimage.com/600x400/000/fff",
						"order_id": ""+res.order_id+"",
						"handler": function (response){
							// alert("Payment Succeeded");
                                $.ajax({
                                    url:"/verifyorder",
                                    type:"POST",
                                    data:{data:res.data},
                                   success: function(response){
                                    if(response.success){
                                        window.location.href = '/ordersuccess'; // Redirect to "/ordersuccess"
                                        alert(response.msg)
                                    }else{
                                        alert("payment failed")
                                    }
                                   }

                                })
                            




							// window.open("/","_self")
						},
						"prefill": {
							"contact":""+res.contact+"",
							"name": ""+res.name+"",
							"email": ""+res.email+""
						},
						"notes" : {
							"description":""+res.description+""
						},
						"theme": {
							"color": "#2300a3"
						}
					};
					var razorpayObject = new Razorpay(options);
					razorpayObject.on('payment.failed', function (response){
							alert("Payment Failed");
					});
					razorpayObject.open();
                    }
					
				}
				else{
					alert(res.msg);
                    console.log(res.msg);
				}
			}
		});

	});
});

</script>  